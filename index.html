<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Data Breach Checker - Test System</title>
    <script src="https://cdn.jsdelivr.net/npm/@tailwindcss/browser@4"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        * { font-family: 'Inter', sans-serif; }
        body { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); min-height: 100vh; }
        .card { backdrop-filter: blur(10px); background: rgba(255, 255, 255, 0.1); border: 1px solid rgba(255, 255, 255, 0.2); }
        .glow { box-shadow: 0 0 20px rgba(102, 126, 234, 0.5); }
    </style>
</head>
<body class="text-gray-100">
    <div class="container mx-auto px-4 py-12 max-w-6xl">
        <header class="text-center mb-12">
            <h1 class="text-4xl md:text-5xl font-bold mb-4">Data Breach Monitoring System</h1>
            <p class="text-xl opacity-90">Test platform for Have I Been Pwned API integration</p>
            <div class="mt-6 flex flex-wrap justify-center gap-4">
                <span class="px-4 py-2 bg-blue-500 rounded-full text-sm font-semibold">Vercel Frontend</span>
                <span class="px-4 py-2 bg-green-500 rounded-full text-sm font-semibold">Render Backend</span>
                <span class="px-4 py-2 bg-purple-500 rounded-full text-sm font-semibold">Hugging Face Datasets</span>
                <span class="px-4 py-2 bg-red-500 rounded-full text-sm font-semibold">Have I Been Pwned API</span>
            </div>
        </header>

        <div id="envBanner" class="hidden mb-10 rounded-2xl border border-yellow-500/40 bg-yellow-900/30 p-5">
            <div class="font-semibold text-yellow-200 mb-1">You are on a Vercel preview/protected deployment</div>
            <div id="envBannerText" class="text-sm text-yellow-100/90"></div>
            <div class="mt-3">
                <a id="envBannerLink" href="https://api-proxy-render.vercel.app/" class="inline-block bg-yellow-500 hover:bg-yellow-400 text-black font-semibold px-4 py-2 rounded-lg">Open production site</a>
            </div>
        </div>

        <div class="grid md:grid-cols-2 gap-8 mb-12">
            <!-- Left column: Email check -->
            <div class="card rounded-2xl p-8 glow">
                <h2 class="text-2xl font-bold mb-6"><i class="fas fa-search mr-3"></i>Check Email for Breaches</h2>
                <p class="mb-6 opacity-90">Enter an email address to check if it appears in known data breaches using the Have I Been Pwned API.</p>
                
                <div class="mb-6">
                    <label class="block mb-2 font-medium">Email Address</label>
                    <div class="flex">
                        <input type="email" id="emailInput" placeholder="user@example.com" class="flex-grow p-4 rounded-l-xl text-gray-900 focus:outline-none focus:ring-2 focus:ring-blue-500">
                        <button id="checkBtn" class="bg-blue-600 hover:bg-blue-700 px-6 rounded-r-xl font-semibold transition duration-200">
                            <i class="fas fa-shield-alt mr-2"></i>Check
                        </button>
                    </div>
                    <p class="text-sm mt-2 opacity-80">We do not store any email addresses. All checks are performed via the HIBP API.</p>
                </div>

                <div class="mt-8">
                    <h3 class="text-xl font-bold mb-4">How It Works</h3>
                    <ul class="space-y-3">
                        <li class="flex items-start"><i class="fas fa-arrow-right mt-1 mr-3 text-blue-400"></i>Your request is sent to our Render backend proxy</li>
                        <li class="flex items-start"><i class="fas fa-arrow-right mt-1 mr-3 text-blue-400"></i>The proxy forwards the request to Have I Been Pwned API</li>
                        <li class="flex items-start"><i class="fas fa-arrow-right mt-1 mr-3 text-blue-400"></i>Results are returned to you in real time</li>
                        <li class="flex items-start"><i class="fas fa-arrow-right mt-1 mr-3 text-blue-400"></i>Separate CI job publishes breach snapshots to Hugging Face</li>
                    </ul>
                </div>

                <div class="mt-10 border-t border-gray-700 pt-8">
                    <h3 class="text-xl font-bold mb-4"><i class="fas fa-globe mr-2"></i>Check Domain / URL</h3>
                    <p class="mb-4 opacity-90">Checks if a domain (or a full URL) appears in known breaches (HIBP domain query).</p>
                    <div class="flex mb-3">
                        <input type="text" id="domainInput" placeholder="example.com or https://example.com" class="flex-grow p-4 rounded-l-xl text-gray-900 focus:outline-none focus:ring-2 focus:ring-blue-500">
                        <button id="domainCheckBtn" class="bg-indigo-600 hover:bg-indigo-700 px-6 rounded-r-xl font-semibold transition duration-200">
                            <i class="fas fa-search mr-2"></i>Check
                        </button>
                    </div>
                    <div id="domainResults" class="text-sm opacity-90"></div>
                </div>

                <div class="mt-8 border-t border-gray-700 pt-8">
                    <h3 class="text-xl font-bold mb-4"><i class="fas fa-key mr-2"></i>Check Password</h3>
                    <p class="mb-4 opacity-90">Uses HIBP Pwned Passwords (k-anonymity). Your password is hashed client-side (SHA-1) and is not sent in plaintext.</p>
                    <div class="flex mb-3">
                        <input type="password" id="passwordInput" placeholder="Enter a password to test" class="flex-grow p-4 rounded-l-xl text-gray-900 focus:outline-none focus:ring-2 focus:ring-blue-500">
                        <button id="passwordCheckBtn" class="bg-emerald-600 hover:bg-emerald-700 px-6 rounded-r-xl font-semibold transition duration-200">
                            <i class="fas fa-shield-alt mr-2"></i>Check
                        </button>
                    </div>
                    <div id="passwordResults" class="text-sm opacity-90"></div>
                </div>
            </div>

            <!-- Right column: Results & Dataset update -->
            <div class="space-y-8">
                <div class="card rounded-2xl p-8">
                    <h2 class="text-2xl font-bold mb-6"><i class="fas fa-list-alt mr-3"></i>Breach Results</h2>
                    <div id="resultsContainer" class="min-h-64">
                        <div class="text-center py-10">
                            <i class="fas fa-lock text-4xl opacity-50 mb-4"></i>
                            <p class="opacity-80">Enter an email address and click "Check" to see if it's been compromised in any data breaches.</p>
                        </div>
                    </div>
                </div>

                <div class="card rounded-2xl p-8">
                    <h2 class="text-2xl font-bold mb-6"><i class="fas fa-database mr-3"></i>Dataset Management</h2>
                    <p class="mb-6 opacity-90">Dataset snapshots are generated by GitHub Actions and uploaded to Hugging Face. Use the button below to refresh the latest published snapshot info.</p>
                    
                    <div class="mb-6">
                        <div class="flex items-center justify-between mb-4">
                            <span class="font-medium">Dataset Status</span>
                            <span id="datasetStatus" class="px-3 py-1 bg-green-900 text-green-300 rounded-full text-sm font-semibold">Up to date</span>
                        </div>
                        <div class="w-full bg-gray-800 rounded-full h-3">
                            <div id="datasetProgress" class="bg-green-500 h-3 rounded-full w-full"></div>
                        </div>
                        <p class="text-sm mt-2 opacity-80" id="lastUpdated">Last updated: Loading...</p>
                    </div>

                    <button id="updateDatasetBtn" class="w-full bg-purple-600 hover:bg-purple-700 py-4 rounded-xl font-semibold text-lg transition duration-200">
                        <i class="fas fa-sync-alt mr-3"></i>Refresh Hugging Face Dataset
                    </button>
                    <p class="text-sm mt-4 opacity-80">This fetches <code class="bg-black px-2 py-1 rounded">datasets/latest.json</code> from your Hugging Face dataset repo (public) to show when the last snapshot was generated.</p>
                </div>
            </div>
        </div>

        <!-- System Architecture Section -->
        <div class="card rounded-2xl p-8 mb-12">
            <h2 class="text-2xl font-bold mb-6"><i class="fas fa-project-diagram mr-3"></i>System Architecture</h2>
            <div class="grid md:grid-cols-4 gap-6">
                <div class="bg-gray-800 p-6 rounded-xl text-center">
                    <div class="text-3xl mb-4 text-blue-400"><i class="fas fa-cloud"></i></div>
                    <h3 class="font-bold text-lg mb-2">Vercel Frontend</h3>
                    <p class="text-sm opacity-90">Static hosting with serverless functions for API routing</p>
                </div>
                <div class="bg-gray-800 p-6 rounded-xl text-center">
                    <div class="text-3xl mb-4 text-green-400"><i class="fas fa-server"></i></div>
                    <h3 class="font-bold text-lg mb-2">Render Backend</h3>
                    <p class="text-sm opacity-90">Proxy server to handle API requests and avoid CORS issues</p>
                    <a href="https://backend-proxy-s43a.onrender.com" target="_blank" class="text-green-300 text-xs mt-3 inline-block">backend-proxy-s43a.onrender.com</a>
                </div>
                <div class="bg-gray-800 p-6 rounded-xl text-center">
                    <div class="text-3xl mb-4 text-purple-400"><i class="fas fa-brain"></i></div>
                    <h3 class="font-bold text-lg mb-2">Hugging Face</h3>
                    <p class="text-sm opacity-90">Stores and version controls breach datasets for easy updates</p>
                </div>
                <div class="bg-gray-800 p-6 rounded-xl text-center">
                    <div class="text-3xl mb-4 text-red-400"><i class="fas fa-shield-alt"></i></div>
                    <h3 class="font-bold text-lg mb-2">HIBP API</h3>
                    <p class="text-sm opacity-90">Primary source of breach data with real-time updates</p>
                </div>
            </div>
        </div>

        <!-- Flow Explanation -->
        <div class="card rounded-2xl p-8">
            <h2 class="text-2xl font-bold mb-6"><i class="fas fa-sitemap mr-3"></i>Data Flow for High Request Volume</h2>
            <div class="mb-8">
                <ol class="space-y-6">
                    <li class="flex items-start">
                        <div class="flex-shrink-0 w-10 h-10 rounded-full bg-blue-600 flex items-center justify-center font-bold mr-4">1</div>
                        <div>
                            <h3 class="font-bold text-lg mb-1">User Request</h3>
                            <p>User submits email check request via Vercel-hosted frontend. The request is routed through our Render backend proxy to avoid CORS and rate limiting.</p>
                        </div>
                    </li>
                    <li class="flex items-start">
                        <div class="flex-shrink-0 w-10 h-10 rounded-full bg-green-600 flex items-center justify-center font-bold mr-4">2</div>
                        <div>
                            <h3 class="font-bold text-lg mb-1">Backend Processing</h3>
                            <p>Render backend forwards request to Have I Been Pwned API with appropriate authentication. Response is cached temporarily to handle multiple simultaneous requests.</p>
                        </div>
                    </li>
                    <li class="flex items-start">
                        <div class="flex-shrink-0 w-10 h-10 rounded-full bg-purple-600 flex items-center justify-center font-bold mr-4">3</div>
                        <div>
                            <h3 class="font-bold text-lg mb-1">Dataset Comparison</h3>
                            <p>Results are compared with our Hugging Face dataset to identify new breaches not yet in our local dataset. If new breaches are found, the dataset update process is triggered.</p>
                        </div>
                    </li>
                    <li class="flex items-start">
                        <div class="flex-shrink-0 w-10 h-10 rounded-full bg-red-600 flex items-center justify-center font-bold mr-4">4</div>
                        <div>
                            <h3 class="font-bold text-lg mb-1">Dataset Update</h3>
                            <p>When new breaches are detected, our system automatically pulls data from multiple sources (including HIBP, dark web monitoring, etc.) and updates the Hugging Face dataset.</p>
                        </div>
                    </li>
                </ol>
            </div>
            <div class="bg-gray-800 p-6 rounded-xl">
                <h3 class="font-bold text-lg mb-3">Current Backend Proxy</h3>
                <div class="flex items-center justify-between">
                    <code class="bg-black p-3 rounded-lg flex-grow mr-4 overflow-x-auto">https://backend-proxy-s43a.onrender.com/api/hibp/check/{email}</code>
                    <button id="testProxyBtn" class="bg-blue-600 hover:bg-blue-700 px-6 py-3 rounded-lg font-semibold whitespace-nowrap">Test Proxy</button>
                </div>
                <p class="text-sm mt-3 opacity-80">This is the actual Render backend proxy that will be used in production. Click "Test Proxy" to verify it's working.</p>
            </div>
        </div>

        <footer class="text-center mt-12 pt-8 border-t border-gray-700 opacity-80">
            <p>Data Breach Monitoring System - Test Platform</p>
            <p class="text-sm mt-2">This is a demonstration system for testing the integration of Have I Been Pwned API with Vercel, Render, and Hugging Face.</p>
            <p class="text-xs mt-4">HIBP requests are made via the backend proxy (which must be configured with a valid API key). Dataset snapshots are uploaded to Hugging Face via CI when configured.</p>
        </footer>
    </div>

    <script>
        // DOM Elements
        const emailInput = document.getElementById('emailInput');
        const checkBtn = document.getElementById('checkBtn');
        const resultsContainer = document.getElementById('resultsContainer');
        const updateDatasetBtn = document.getElementById('updateDatasetBtn');
        const datasetStatus = document.getElementById('datasetStatus');
        const datasetProgress = document.getElementById('datasetProgress');
        const lastUpdated = document.getElementById('lastUpdated');
        const testProxyBtn = document.getElementById('testProxyBtn');
        const domainInput = document.getElementById('domainInput');
        const domainCheckBtn = document.getElementById('domainCheckBtn');
        const domainResults = document.getElementById('domainResults');
        const passwordInput = document.getElementById('passwordInput');
        const passwordCheckBtn = document.getElementById('passwordCheckBtn');
        const passwordResults = document.getElementById('passwordResults');

        const API_BASE = '';
        const DIRECT_RENDER_BASE = 'https://backend-proxy-s43a.onrender.com';

        // Configure your public Hugging Face dataset repo id (e.g. "tiago/hibp-breaches-dataset")
        const HF_DATASET_REPO = 'Tiago2024180/eyewebdataset';

        // Show a banner when running on a protected Vercel preview URL to avoid confusing HTML auth/500 pages.
        (function showEnvBanner() {
            try {
                const host = window.location.hostname || '';
                const href = window.location.href || '';
                const isPreviewProjects = /-projects\.vercel\.app$/i.test(host);
                const isPreviewHashed = /\.vercel\.app$/i.test(host) && host.includes('-') && host !== 'api-proxy-render.vercel.app';
                if (!isPreviewProjects && !isPreviewHashed) return;

                const banner = document.getElementById('envBanner');
                const text = document.getElementById('envBannerText');
                if (!banner || !text) return;
                banner.classList.remove('hidden');
                text.textContent = `Current URL: ${href}. If /api calls return HTML (401/500), disable Vercel Deployment Protection for previews or use the production URL.`;
            } catch {
                // ignore
            }
        })();

        // Sample breach data for simulation
        const sampleBreaches = [
            { name: "Adobe", domain: "adobe.com", breachDate: "2013-10-04", pwnCount: 152445165 },
            { name: "LinkedIn", domain: "linkedin.com", breachDate: "2012-05-05", pwnCount: 164611595 },
            { name: "Dropbox", domain: "dropbox.com", breachDate: "2012-07-01", pwnCount: 68740998 },
            { name: "Twitter", domain: "twitter.com", breachDate: "2018-01-01", pwnCount: 33000000 },
            { name: "Canva", domain: "canva.com", breachDate: "2019-05-01", pwnCount: 137272516 }
        ];

        // Current dataset state
        let datasetLastUpdated = new Date();
        let datasetUpdateInProgress = false;

        function isProbablyHtml(text) {
            const t = (text || '').trim();
            return t.startsWith('<!doctype html') || t.startsWith('<html') || t.startsWith('<');
        }

        async function fetchWithTimeout(url, options = {}, timeoutMs = 25000) {
            const controller = new AbortController();
            const id = setTimeout(() => controller.abort(), timeoutMs);
            try {
                return await fetch(url, { ...options, signal: controller.signal });
            } finally {
                clearTimeout(id);
            }
        }

        async function readResponseBodySmart(response) {
            const contentType = (response.headers.get('content-type') || '').toLowerCase();
            const text = await response.text();
            if (contentType.includes('application/json')) {
                try {
                    return { kind: 'json', value: JSON.parse(text), rawText: text };
                } catch {
                    return { kind: 'text', value: text, rawText: text };
                }
            }
            return { kind: isProbablyHtml(text) ? 'html' : 'text', value: text, rawText: text };
        }

        async function requestApi(url, options = {}, { timeoutMs = 25000, retries = 1 } = {}) {
            let lastErr = null;
            for (let attempt = 1; attempt <= Math.max(1, retries); attempt++) {
                try {
                    const response = await fetchWithTimeout(url, options, timeoutMs);
                    const body = await readResponseBodySmart(response);
                    return { ok: response.ok, status: response.status, body };
                } catch (e) {
                    lastErr = e;
                }
            }
            throw lastErr || new Error('Request failed');
        }

        function shouldFallback(result) {
            return !result.ok && (result.status >= 500 || result.body.kind === 'html');
        }

        async function requestApiWithFallback(path, options = {}, opts = {}) {
            const primaryUrl = `${API_BASE}${path}`;
            const primary = await requestApi(primaryUrl, options, opts);
            if (!shouldFallback(primary)) return { ...primary, fallbackUsed: false };

            const fallbackUrl = `${DIRECT_RENDER_BASE}${path}`;
            const fallback = await requestApi(fallbackUrl, options, opts);
            return { ...fallback, fallbackUsed: true, primaryStatus: primary.status, primaryBody: primary.body };
        }

        // Format date for display
        function formatDate(date) {
            return date.toISOString().split('T')[0] + ' ' + date.toISOString().split('T')[1].substring(0,5) + ' UTC';
        }

        // Update the last updated display immediately
        lastUpdated.textContent = `Last updated: ${formatDate(datasetLastUpdated)}`;

        // Function to display results (adapted for real HIBP API response)
        function displayResults(email, breaches, error = null) {
            // Se houve erro
            if (error) {
                resultsContainer.innerHTML = `
                    <div class="text-center py-10">
                        <div class="w-20 h-20 bg-yellow-900 text-yellow-400 rounded-full flex items-center justify-center mx-auto mb-4">
                            <i class="fas fa-exclamation-circle text-3xl"></i>
                        </div>
                        <h3 class="text-2xl font-bold mb-2">Erro na verificação</h3>
                        <p class="opacity-90 mb-4">${error}</p>
                        <p class="text-sm opacity-80">Verifique se o backend está a correr e se a API key está configurada.</p>
                        <div class="mt-4 p-4 bg-gray-800 rounded-xl text-left text-sm">
                            <p class="font-bold mb-2">Possíveis causas:</p>
                            <ul class="list-disc list-inside space-y-1">
                                <li>Backend Render está em cold start (aguarde 30s)</li>
                                <li>API Key do HIBP não configurada no backend</li>
                                <li>Endpoint incorreto no backend</li>
                                <li>Rate limit excedido na API</li>
                            </ul>
                        </div>
                    </div>
                `;
                return;
            }
            
            // Sem vazamentos encontrados
            if (!breaches || breaches.length === 0) {
                resultsContainer.innerHTML = `
                    <div class="text-center py-10">
                        <div class="w-20 h-20 bg-green-900 text-green-400 rounded-full flex items-center justify-center mx-auto mb-4">
                            <i class="fas fa-check text-3xl"></i>
                        </div>
                        <h3 class="text-2xl font-bold mb-2">Nenhum vazamento encontrado!</h3>
                        <p class="opacity-90">O email <strong>${email}</strong> não foi encontrado em nenhum vazamento conhecido.</p>
                        <p class="text-sm mt-4 opacity-80">Boas notícias! Mesmo assim, use sempre passwords únicas para cada serviço.</p>
                    </div>
                `;
                return;
            }

            // Mostrar vazamentos encontrados (formato real da HIBP API)
            let breachesHTML = '';
            breaches.forEach(breach => {
                // A HIBP API retorna: Name, Domain, BreachDate, PwnCount, DataClasses, Description, etc.
                const name = breach.Name || breach.name || 'Desconhecido';
                const domain = breach.Domain || breach.domain || 'N/A';
                const breachDate = breach.BreachDate || breach.breachDate || 'N/A';
                const pwnCount = breach.PwnCount || breach.pwnCount || 0;
                const dataClasses = breach.DataClasses || breach.dataClasses || [];
                const description = breach.Description || breach.description || '';
                
                breachesHTML += `
                    <div class="bg-gray-800 p-5 rounded-xl mb-4 border-l-4 border-red-500">
                        <div class="flex justify-between items-start flex-wrap gap-2">
                            <div>
                                <h4 class="font-bold text-lg">${name}</h4>
                                <p class="text-sm opacity-80">Domínio: ${domain} | Data: ${breachDate}</p>
                            </div>
                            <div class="bg-red-900 text-red-300 px-3 py-1 rounded-full text-sm font-semibold">
                                ${pwnCount.toLocaleString()} contas
                            </div>
                        </div>
                        ${dataClasses.length > 0 ? `
                        <div class="mt-3 flex flex-wrap gap-2">
                            ${dataClasses.map(dc => `<span class="bg-gray-700 px-2 py-1 rounded text-xs">${dc}</span>`).join('')}
                        </div>
                        ` : ''}
                        ${description ? `
                        <div class="mt-3 text-sm opacity-90">
                            <p>${description.substring(0, 200)}${description.length > 200 ? '...' : ''}</p>
                        </div>
                        ` : ''}
                    </div>
                `;
            });

            resultsContainer.innerHTML = `
                <div class="mb-6">
                    <div class="w-20 h-20 bg-red-900 text-red-400 rounded-full flex items-center justify-center mx-auto mb-4">
                        <i class="fas fa-exclamation-triangle text-3xl"></i>
                    </div>
                    <h3 class="text-2xl font-bold mb-2 text-center">Vazamentos Encontrados!</h3>
                    <p class="text-center opacity-90 mb-6">O email <strong>${email}</strong> foi encontrado em <strong>${breaches.length}</strong> vazamento(s).</p>
                </div>
                <div class="max-h-96 overflow-y-auto pr-2">
                    ${breachesHTML}
                </div>
                <div class="mt-6 p-4 bg-blue-900 rounded-xl">
                    <p class="text-sm"><i class="fas fa-lightbulb mr-2"></i><strong>Recomendação:</strong> Altere as passwords destes serviços e ative autenticação de dois fatores onde possível.</p>
                </div>
            `;
        }

        // Function to check email via REAL Render backend proxy
        async function checkEmail(email) {
            // Show loading state
            resultsContainer.innerHTML = `
                <div class="text-center py-10">
                    <div class="inline-block animate-spin rounded-full h-12 w-12 border-t-2 border-b-2 border-blue-500 mb-4"></div>
                    <h3 class="text-xl font-bold mb-2">A verificar vazamentos...</h3>
                    <p class="opacity-90">A consultar Have I Been Pwned API via backend Render...</p>
                    <p class="text-xs opacity-60 mt-2">Nota: O servidor Render pode demorar ~30s se estiver em cold start</p>
                </div>
            `;
            
            try {
                console.log(`[HIBP] Checking email: ${email}`);
                console.log(`[HIBP] Calling: ${API_BASE}/api/hibp/check/${encodeURIComponent(email)}`);
                
                // Chamada REAL ao backend Render
                const response = await fetchWithTimeout(`${API_BASE}/api/hibp/check/${encodeURIComponent(email)}`, {
                    method: 'GET',
                    headers: {
                        'Accept': 'application/json'
                    }
                }, 30000);

                console.log(`[HIBP] Response status: ${response.status}`);
                
                // Se não encontrou vazamentos (404 na HIBP API significa "não encontrado")
                if (response.status === 404) {
                    console.log('[HIBP] No breaches found (404)');
                    return { email, breaches: [], error: null };
                }
                
                // Se houve erro
                if (!response.ok) {
                    const parsed = await readResponseBodySmart(response);
                    const errorText = (parsed.kind === 'json' && parsed.value && parsed.value.error) ? parsed.value.error : (parsed.rawText || 'Falha na comunicação com o backend');
                    console.error('[HIBP] Backend error:', response.status, errorText);
                    return { email, breaches: [], error: `Erro ${response.status}: ${errorText || 'Falha na comunicação com o backend'}` };
                }
                
                // Sucesso - tem vazamentos
                const breaches = await response.json();
                console.log(`[HIBP] Found ${breaches.length} breaches:`, breaches);
                return { email, breaches, error: null };
                
            } catch (error) {
                console.error('[HIBP] Fetch error:', error);
                return { email, breaches: [], error: `Erro de conexão: ${error.message}. Verifique se o backend está online.` };
            }
        }

        async function checkDomain(domainOrUrl) {
            const value = (domainOrUrl || '').trim();
            if (!value) return { breaches: [], error: 'Please enter a domain or URL.' };
            try {
                domainResults.innerHTML = `
                    <div class="text-center py-4">
                        <div class="inline-block animate-spin rounded-full h-8 w-8 border-t-2 border-b-2 border-indigo-400 mb-2"></div>
                        <div class="font-semibold">A verificar domínio/URL...</div>
                        <div class="text-xs opacity-70 mt-1">A consultar via backend Render (pode demorar no cold start)</div>
                    </div>
                `;

                const { ok, status, body, fallbackUsed } = await requestApiWithFallback(
                    `/api/hibp/domain/${encodeURIComponent(value)}`,
                    { method: 'GET', headers: { 'Accept': 'application/json' } },
                    { timeoutMs: 30000, retries: 2 }
                );

                if (!ok) {
                    const msg = (body.kind === 'json' && body.value && body.value.error) ? body.value.error
                        : (body.kind === 'html' ? 'O servidor devolveu HTML em vez de JSON (possível erro do proxy/deploy).' : (body.rawText || 'Erro desconhecido'));
                    const via = fallbackUsed ? ' (fallback direto Render)' : '';
                    return { breaches: [], error: `Erro ${status}: ${msg}${via}` };
                }

                const breaches = Array.isArray(body.value) ? body.value : [];
                return { breaches, error: null };
            } catch (e) {
                return { breaches: [], error: `Erro de conexão: ${e.message}` };
            }
        }

        function toHex(buffer) {
            return Array.from(new Uint8Array(buffer)).map(b => b.toString(16).padStart(2, '0')).join('');
        }

        async function sha1HexUpper(text) {
            const data = new TextEncoder().encode(text);
            const digest = await crypto.subtle.digest('SHA-1', data);
            return toHex(digest).toUpperCase();
        }

        async function checkPassword(password) {
            const value = (password || '');
            if (!value) return { pwned: false, count: 0, error: 'Please enter a password.' };
            try {
                passwordResults.innerHTML = `
                    <div class="text-center py-4">
                        <div class="inline-block animate-spin rounded-full h-8 w-8 border-t-2 border-b-2 border-emerald-400 mb-2"></div>
                        <div class="font-semibold">A verificar password (k-anonymity)...</div>
                        <div class="text-xs opacity-70 mt-1">A hash (SHA-1) é feita no browser; enviamos apenas o hash</div>
                    </div>
                `;

                let sha1 = null;
                try {
                    sha1 = await sha1HexUpper(value);
                } catch (hashErr) {
                    return { pwned: false, count: 0, error: `Falha a gerar SHA-1 no browser: ${hashErr.message || hashErr}` };
                }

                const { ok, status, body, fallbackUsed } = await requestApiWithFallback(
                    '/api/hibp/password',
                    {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json', 'Accept': 'application/json' },
                        body: JSON.stringify({ sha1 })
                    },
                    { timeoutMs: 30000, retries: 2 }
                );

                if (!ok) {
                    const msg = (body.kind === 'json' && body.value && body.value.error) ? body.value.error
                        : (body.kind === 'html' ? 'O servidor devolveu HTML em vez de JSON (proxy/proteção/deploy).' : (body.rawText || 'Erro desconhecido'));
                    const via = fallbackUsed ? ' (fallback direto Render)' : '';
                    return { pwned: false, count: 0, error: `Erro ${status}: ${msg}${via}` };
                }

                const result = (body.kind === 'json') ? body.value : null;
                return { pwned: !!(result && result.pwned), count: (result && result.count) ? result.count : 0, error: null };
            } catch (e) {
                return { pwned: false, count: 0, error: `Erro de conexão: ${e.message}` };
            }
        }

        // Refresh dataset status from Hugging Face (public)
        async function updateDataset() {
            if (datasetUpdateInProgress) return;

            datasetUpdateInProgress = true;
            updateDatasetBtn.disabled = true;
            updateDatasetBtn.innerHTML = '<i class="fas fa-spinner animate-spin mr-3"></i>Refreshing...';
            datasetStatus.textContent = 'Checking...';
            datasetStatus.className = 'px-3 py-1 bg-yellow-900 text-yellow-300 rounded-full text-sm font-semibold';
            datasetProgress.style.width = '30%';

            try {
                if (!HF_DATASET_REPO || HF_DATASET_REPO === 'YOUR_USER/YOUR_DATASET') {
                    datasetStatus.textContent = 'Not configured';
                    datasetStatus.className = 'px-3 py-1 bg-red-900 text-red-300 rounded-full text-sm font-semibold';
                    datasetProgress.style.width = '0%';
                    lastUpdated.textContent = 'Set HF_DATASET_REPO in index.html (e.g. "tiago/hibp-breaches-dataset")';
                    return;
                }

                // Preferred: stable metadata pointer created by CI (datasets/latest.json)
                const url = `https://huggingface.co/datasets/${HF_DATASET_REPO}/resolve/main/datasets/latest.json?t=${Date.now()}`;
                let meta = null;
                let usedFallback = false;

                const response = await fetch(url, { method: 'GET', headers: { 'Accept': 'application/json' } });
                datasetProgress.style.width = '70%';

                if (response.ok) {
                    meta = await response.json();
                } else if (response.status === 404) {
                    // Fallback: if latest.json isn't published yet, use HF API to get lastModified
                    // and infer the most recent timestamped snapshot filename.
                    usedFallback = true;
                    const apiUrl = `https://huggingface.co/api/datasets/${HF_DATASET_REPO}?t=${Date.now()}`;
                    const apiRes = await fetch(apiUrl, { method: 'GET', headers: { 'Accept': 'application/json' } });
                    if (!apiRes.ok) {
                        const text = await apiRes.text();
                        throw new Error(`HF API responded ${apiRes.status}: ${text}`);
                    }
                    const info = await apiRes.json();
                    const siblings = Array.isArray(info.siblings) ? info.siblings : [];
                    const files = siblings
                        .map(s => (s && s.rfilename ? String(s.rfilename) : ''))
                        .filter(Boolean);
                    const snapshots = files
                        .filter(f => /^datasets\/breaches-.*\.json$/i.test(f))
                        .sort();
                    const latestSnapshot = snapshots.length ? snapshots[snapshots.length - 1] : null;

                    meta = {
                        generated_at: info.lastModified || info.last_modified || null,
                        file: latestSnapshot ? latestSnapshot.replace(/^datasets\//i, '') : 'unknown'
                    };
                } else {
                    const text = await response.text();
                    throw new Error(`HF responded ${response.status}: ${text}`);
                }

                const generatedAt = meta && meta.generated_at ? new Date(meta.generated_at) : null;
                const file = (meta && meta.file) ? meta.file : 'unknown';

                datasetStatus.textContent = 'Up to date';
                datasetStatus.className = 'px-3 py-1 bg-green-900 text-green-300 rounded-full text-sm font-semibold';
                datasetProgress.style.width = '100%';

                if (generatedAt && !Number.isNaN(generatedAt.getTime())) {
                    datasetLastUpdated = generatedAt;
                    lastUpdated.textContent = `Last updated: ${formatDate(datasetLastUpdated)} (file: ${file})${usedFallback ? ' (fallback)' : ''}`;
                } else {
                    lastUpdated.textContent = `Last updated: Unknown (file: ${file})${usedFallback ? ' (fallback)' : ''}`;
                }
            } catch (error) {
                console.error('[HF] Dataset status error:', error);
                datasetStatus.textContent = 'Error';
                datasetStatus.className = 'px-3 py-1 bg-red-900 text-red-300 rounded-full text-sm font-semibold';
                datasetProgress.style.width = '0%';
                lastUpdated.textContent = `Failed to fetch Hugging Face dataset status: ${error.message}`;
            } finally {
                updateDatasetBtn.disabled = false;
                updateDatasetBtn.innerHTML = '<i class="fas fa-sync-alt mr-3"></i>Refresh Hugging Face Dataset';
                datasetUpdateInProgress = false;
            }
        }

        // Function to test the proxy connection
        async function testProxy() {
            testProxyBtn.disabled = true;
            testProxyBtn.innerHTML = '<i class="fas fa-spinner animate-spin mr-2"></i>Testing...';
            
            try {
                // Call a known API endpoint through the Vercel rewrite.
                const response = await fetch('/api/hibp/breaches', { method: 'GET', headers: { 'Accept': 'application/json' } });
                
                setTimeout(() => {
                    if (response.status) {
                        alert(`Proxy is reachable! Status: ${response.status}`);
                    } else {
                        alert('Proxy is reachable but returned an unexpected response.');
                    }
                    testProxyBtn.disabled = false;
                    testProxyBtn.innerHTML = 'Test Proxy';
                }, 1000);
            } catch (error) {
                setTimeout(() => {
                    alert('Could not connect to the proxy. It might be offline or the endpoint may be different.');
                    testProxyBtn.disabled = false;
                    testProxyBtn.innerHTML = 'Test Proxy';
                }, 1000);
            }
        }

        // Event Listeners
        checkBtn.addEventListener('click', async () => {
            const email = emailInput.value.trim();
            if (!email) {
                alert('Please enter an email address');
                return;
            }
            
            // Basic email validation
            if (!email.includes('@') || !email.includes('.')) {
                alert('Please enter a valid email address');
                return;
            }
            
            checkBtn.disabled = true;
            const old = checkBtn.innerHTML;
            checkBtn.innerHTML = '<i class="fas fa-spinner animate-spin mr-2"></i>Checking';
            try {
                const result = await checkEmail(email);
                displayResults(result.email, result.breaches, result.error);
            } finally {
                checkBtn.disabled = false;
                checkBtn.innerHTML = old;
            }
        });

        // Allow Enter key to trigger check
        emailInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                checkBtn.click();
            }
        });

        updateDatasetBtn.addEventListener('click', updateDataset);
        testProxyBtn.addEventListener('click', testProxy);

        domainCheckBtn.addEventListener('click', async () => {
            domainCheckBtn.disabled = true;
            const old = domainCheckBtn.innerHTML;
            domainCheckBtn.innerHTML = '<i class="fas fa-spinner animate-spin mr-2"></i>Checking';
            try {
                const result = await checkDomain(domainInput.value);
                if (result.error) {
                    domainResults.innerHTML = `<div class="text-red-300">${result.error}</div>`;
                    return;
                }
                if (!result.breaches || result.breaches.length === 0) {
                    domainResults.innerHTML = '<div class="text-green-300">No breaches found for this domain.</div>';
                    return;
                }
                const list = result.breaches.slice(0, 8).map(b => `<li><strong>${b.Name || b.Title || 'Unknown'}</strong> (${b.BreachDate || 'n/a'})</li>`).join('');
                const extra = result.breaches.length > 8 ? `<div class="opacity-70 mt-2">+${result.breaches.length - 8} more</div>` : '';
                domainResults.innerHTML = `<div class="text-yellow-200">Found ${result.breaches.length} breach(es):</div><ul class="list-disc ml-6 mt-2">${list}</ul>${extra}`;
            } finally {
                domainCheckBtn.disabled = false;
                domainCheckBtn.innerHTML = old;
            }
        });

        passwordCheckBtn.addEventListener('click', async () => {
            passwordCheckBtn.disabled = true;
            const old = passwordCheckBtn.innerHTML;
            passwordCheckBtn.innerHTML = '<i class="fas fa-spinner animate-spin mr-2"></i>Checking';
            try {
                const result = await checkPassword(passwordInput.value);
                if (result.error) {
                    passwordResults.innerHTML = `<div class="text-red-300">${result.error}</div>`;
                    return;
                }
                if (!result.pwned) {
                    passwordResults.innerHTML = '<div class="text-green-300">Not found in Pwned Passwords.</div>';
                    return;
                }
                passwordResults.innerHTML = `<div class="text-yellow-200">This password was seen <strong>${result.count}</strong> times in breaches. Change it.</div>`;
            } finally {
                passwordCheckBtn.disabled = false;
                passwordCheckBtn.innerHTML = old;
            }
        });

        // Load dataset status on page load
        setTimeout(() => {
            updateDataset();
        }, 500);

        // Initialize with a sample check on page load (after a delay)
        setTimeout(() => {
            emailInput.value = 'test@example.com';
            // Don't auto-check to avoid confusion
        }, 1000);
    </script>
</body>
</html>