<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Data Breach Checker - Test System</title>
    <script src="https://cdn.jsdelivr.net/npm/@tailwindcss/browser@4"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        * { font-family: 'Inter', sans-serif; }
        body { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); min-height: 100vh; }
        .card { backdrop-filter: blur(10px); background: rgba(255, 255, 255, 0.1); border: 1px solid rgba(255, 255, 255, 0.2); }
        .glow { box-shadow: 0 0 20px rgba(102, 126, 234, 0.5); }
    </style>
</head>
<body class="text-gray-100">
    <div class="container mx-auto px-4 py-12 max-w-6xl">
        <header class="text-center mb-12">
            <h1 class="text-4xl md:text-5xl font-bold mb-4">Data Breach Monitoring System</h1>
            <p class="text-xl opacity-90">Test platform for Have I Been Pwned API integration</p>
            <div class="mt-6 flex flex-wrap justify-center gap-4">
                <span class="px-4 py-2 bg-blue-500 rounded-full text-sm font-semibold">Vercel Frontend</span>
                <span class="px-4 py-2 bg-green-500 rounded-full text-sm font-semibold">Render Backend</span>
                <span class="px-4 py-2 bg-purple-500 rounded-full text-sm font-semibold">Hugging Face Datasets</span>
                <span class="px-4 py-2 bg-red-500 rounded-full text-sm font-semibold">Have I Been Pwned API</span>
            </div>
        </header>

        <div class="grid md:grid-cols-2 gap-8 mb-12">
            <!-- Left column: Email check -->
            <div class="card rounded-2xl p-8 glow">
                <h2 class="text-2xl font-bold mb-6"><i class="fas fa-search mr-3"></i>Check Email for Breaches</h2>
                <p class="mb-6 opacity-90">Enter an email address to check if it appears in known data breaches using the Have I Been Pwned API.</p>
                
                <div class="mb-6">
                    <label class="block mb-2 font-medium">Email Address</label>
                    <div class="flex">
                        <input type="email" id="emailInput" placeholder="user@example.com" class="flex-grow p-4 rounded-l-xl text-gray-900 focus:outline-none focus:ring-2 focus:ring-blue-500">
                        <button id="checkBtn" class="bg-blue-600 hover:bg-blue-700 px-6 rounded-r-xl font-semibold transition duration-200">
                            <i class="fas fa-shield-alt mr-2"></i>Check
                        </button>
                    </div>
                    <p class="text-sm mt-2 opacity-80">We do not store any email addresses. All checks are performed via the HIBP API.</p>
                </div>

                <div class="mt-8">
                    <h3 class="text-xl font-bold mb-4">How It Works</h3>
                    <ul class="space-y-3">
                        <li class="flex items-start"><i class="fas fa-arrow-right mt-1 mr-3 text-blue-400"></i>Your request is sent to our Render backend proxy</li>
                        <li class="flex items-start"><i class="fas fa-arrow-right mt-1 mr-3 text-blue-400"></i>The proxy forwards the request to Have I Been Pwned API</li>
                        <li class="flex items-start"><i class="fas fa-arrow-right mt-1 mr-3 text-blue-400"></i>Results are compared with our Hugging Face dataset</li>
                        <li class="flex items-start"><i class="fas fa-arrow-right mt-1 mr-3 text-blue-400"></i>Updated breach information is returned to you</li>
                    </ul>
                </div>
            </div>

            <!-- Right column: Results & Dataset update -->
            <div class="space-y-8">
                <div class="card rounded-2xl p-8">
                    <h2 class="text-2xl font-bold mb-6"><i class="fas fa-list-alt mr-3"></i>Breach Results</h2>
                    <div id="resultsContainer" class="min-h-64">
                        <div class="text-center py-10">
                            <i class="fas fa-lock text-4xl opacity-50 mb-4"></i>
                            <p class="opacity-80">Enter an email address and click "Check" to see if it's been compromised in any data breaches.</p>
                        </div>
                    </div>
                </div>

                <div class="card rounded-2xl p-8">
                    <h2 class="text-2xl font-bold mb-6"><i class="fas fa-database mr-3"></i>Dataset Management</h2>
                    <p class="mb-6 opacity-90">Our system automatically updates breach datasets from multiple sources. You can manually trigger an update simulation.</p>
                    
                    <div class="mb-6">
                        <div class="flex items-center justify-between mb-4">
                            <span class="font-medium">Dataset Status</span>
                            <span id="datasetStatus" class="px-3 py-1 bg-green-900 text-green-300 rounded-full text-sm font-semibold">Up to date</span>
                        </div>
                        <div class="w-full bg-gray-800 rounded-full h-3">
                            <div id="datasetProgress" class="bg-green-500 h-3 rounded-full w-full"></div>
                        </div>
                        <p class="text-sm mt-2 opacity-80" id="lastUpdated">Last updated: Loading...</p>
                    </div>

                    <button id="updateDatasetBtn" class="w-full bg-purple-600 hover:bg-purple-700 py-4 rounded-xl font-semibold text-lg transition duration-200">
                        <i class="fas fa-sync-alt mr-3"></i>Simulate Dataset Update
                    </button>
                    <p class="text-sm mt-4 opacity-80">This simulates fetching new breach data from sources and updating our Hugging Face dataset.</p>
                </div>
            </div>
        </div>

        <!-- System Architecture Section -->
        <div class="card rounded-2xl p-8 mb-12">
            <h2 class="text-2xl font-bold mb-6"><i class="fas fa-project-diagram mr-3"></i>System Architecture</h2>
            <div class="grid md:grid-cols-4 gap-6">
                <div class="bg-gray-800 p-6 rounded-xl text-center">
                    <div class="text-3xl mb-4 text-blue-400"><i class="fas fa-cloud"></i></div>
                    <h3 class="font-bold text-lg mb-2">Vercel Frontend</h3>
                    <p class="text-sm opacity-90">Static hosting with serverless functions for API routing</p>
                </div>
                <div class="bg-gray-800 p-6 rounded-xl text-center">
                    <div class="text-3xl mb-4 text-green-400"><i class="fas fa-server"></i></div>
                    <h3 class="font-bold text-lg mb-2">Render Backend</h3>
                    <p class="text-sm opacity-90">Proxy server to handle API requests and avoid CORS issues</p>
                    <a href="https://backend-proxy-s43a.onrender.com" target="_blank" class="text-green-300 text-xs mt-3 inline-block">backend-proxy-s43a.onrender.com</a>
                </div>
                <div class="bg-gray-800 p-6 rounded-xl text-center">
                    <div class="text-3xl mb-4 text-purple-400"><i class="fas fa-brain"></i></div>
                    <h3 class="font-bold text-lg mb-2">Hugging Face</h3>
                    <p class="text-sm opacity-90">Stores and version controls breach datasets for easy updates</p>
                </div>
                <div class="bg-gray-800 p-6 rounded-xl text-center">
                    <div class="text-3xl mb-4 text-red-400"><i class="fas fa-shield-alt"></i></div>
                    <h3 class="font-bold text-lg mb-2">HIBP API</h3>
                    <p class="text-sm opacity-90">Primary source of breach data with real-time updates</p>
                </div>
            </div>
        </div>

        <!-- Flow Explanation -->
        <div class="card rounded-2xl p-8">
            <h2 class="text-2xl font-bold mb-6"><i class="fas fa-sitemap mr-3"></i>Data Flow for High Request Volume</h2>
            <div class="mb-8">
                <ol class="space-y-6">
                    <li class="flex items-start">
                        <div class="flex-shrink-0 w-10 h-10 rounded-full bg-blue-600 flex items-center justify-center font-bold mr-4">1</div>
                        <div>
                            <h3 class="font-bold text-lg mb-1">User Request</h3>
                            <p>User submits email check request via Vercel-hosted frontend. The request is routed through our Render backend proxy to avoid CORS and rate limiting.</p>
                        </div>
                    </li>
                    <li class="flex items-start">
                        <div class="flex-shrink-0 w-10 h-10 rounded-full bg-green-600 flex items-center justify-center font-bold mr-4">2</div>
                        <div>
                            <h3 class="font-bold text-lg mb-1">Backend Processing</h3>
                            <p>Render backend forwards request to Have I Been Pwned API with appropriate authentication. Response is cached temporarily to handle multiple simultaneous requests.</p>
                        </div>
                    </li>
                    <li class="flex items-start">
                        <div class="flex-shrink-0 w-10 h-10 rounded-full bg-purple-600 flex items-center justify-center font-bold mr-4">3</div>
                        <div>
                            <h3 class="font-bold text-lg mb-1">Dataset Comparison</h3>
                            <p>Results are compared with our Hugging Face dataset to identify new breaches not yet in our local dataset. If new breaches are found, the dataset update process is triggered.</p>
                        </div>
                    </li>
                    <li class="flex items-start">
                        <div class="flex-shrink-0 w-10 h-10 rounded-full bg-red-600 flex items-center justify-center font-bold mr-4">4</div>
                        <div>
                            <h3 class="font-bold text-lg mb-1">Dataset Update</h3>
                            <p>When new breaches are detected, our system automatically pulls data from multiple sources (including HIBP, dark web monitoring, etc.) and updates the Hugging Face dataset.</p>
                        </div>
                    </li>
                </ol>
            </div>
            <div class="bg-gray-800 p-6 rounded-xl">
                <h3 class="font-bold text-lg mb-3">Current Backend Proxy</h3>
                <div class="flex items-center justify-between">
                    <code class="bg-black p-3 rounded-lg flex-grow mr-4 overflow-x-auto">https://backend-proxy-s43a.onrender.com/api/hibp/check/{email}</code>
                    <button id="testProxyBtn" class="bg-blue-600 hover:bg-blue-700 px-6 py-3 rounded-lg font-semibold whitespace-nowrap">Test Proxy</button>
                </div>
                <p class="text-sm mt-3 opacity-80">This is the actual Render backend proxy that will be used in production. Click "Test Proxy" to verify it's working.</p>
            </div>
        </div>

        <footer class="text-center mt-12 pt-8 border-t border-gray-700 opacity-80">
            <p>Data Breach Monitoring System - Test Platform</p>
            <p class="text-sm mt-2">This is a demonstration system for testing the integration of Have I Been Pwned API with Vercel, Render, and Hugging Face.</p>
            <p class="text-xs mt-4">Note: This is a simulation. Real HIBP API calls require an API key and proper authentication.</p>
        </footer>
    </div>

    <script>
        // DOM Elements
        const emailInput = document.getElementById('emailInput');
        const checkBtn = document.getElementById('checkBtn');
        const resultsContainer = document.getElementById('resultsContainer');
        const updateDatasetBtn = document.getElementById('updateDatasetBtn');
        const datasetStatus = document.getElementById('datasetStatus');
        const datasetProgress = document.getElementById('datasetProgress');
        const lastUpdated = document.getElementById('lastUpdated');
        const testProxyBtn = document.getElementById('testProxyBtn');

        // Sample breach data for simulation
        const sampleBreaches = [
            { name: "Adobe", domain: "adobe.com", breachDate: "2013-10-04", pwnCount: 152445165 },
            { name: "LinkedIn", domain: "linkedin.com", breachDate: "2012-05-05", pwnCount: 164611595 },
            { name: "Dropbox", domain: "dropbox.com", breachDate: "2012-07-01", pwnCount: 68740998 },
            { name: "Twitter", domain: "twitter.com", breachDate: "2018-01-01", pwnCount: 33000000 },
            { name: "Canva", domain: "canva.com", breachDate: "2019-05-01", pwnCount: 137272516 }
        ];

        // Current dataset state
        let datasetLastUpdated = new Date();
        let datasetUpdateInProgress = false;

        // Format date for display
        function formatDate(date) {
            return date.toISOString().split('T')[0] + ' ' + date.toISOString().split('T')[1].substring(0,5) + ' UTC';
        }

        // Update the last updated display immediately
        lastUpdated.textContent = `Last updated: ${formatDate(datasetLastUpdated)}`;

        // Function to display results (adapted for real HIBP API response)
        function displayResults(email, breaches, error = null) {
            // Se houve erro
            if (error) {
                resultsContainer.innerHTML = `
                    <div class="text-center py-10">
                        <div class="w-20 h-20 bg-yellow-900 text-yellow-400 rounded-full flex items-center justify-center mx-auto mb-4">
                            <i class="fas fa-exclamation-circle text-3xl"></i>
                        </div>
                        <h3 class="text-2xl font-bold mb-2">Erro na verificação</h3>
                        <p class="opacity-90 mb-4">${error}</p>
                        <p class="text-sm opacity-80">Verifique se o backend está a correr e se a API key está configurada.</p>
                        <div class="mt-4 p-4 bg-gray-800 rounded-xl text-left text-sm">
                            <p class="font-bold mb-2">Possíveis causas:</p>
                            <ul class="list-disc list-inside space-y-1">
                                <li>Backend Render está em cold start (aguarde 30s)</li>
                                <li>API Key do HIBP não configurada no backend</li>
                                <li>Endpoint incorreto no backend</li>
                                <li>Rate limit excedido na API</li>
                            </ul>
                        </div>
                    </div>
                `;
                return;
            }
            
            // Sem vazamentos encontrados
            if (!breaches || breaches.length === 0) {
                resultsContainer.innerHTML = `
                    <div class="text-center py-10">
                        <div class="w-20 h-20 bg-green-900 text-green-400 rounded-full flex items-center justify-center mx-auto mb-4">
                            <i class="fas fa-check text-3xl"></i>
                        </div>
                        <h3 class="text-2xl font-bold mb-2">Nenhum vazamento encontrado!</h3>
                        <p class="opacity-90">O email <strong>${email}</strong> não foi encontrado em nenhum vazamento conhecido.</p>
                        <p class="text-sm mt-4 opacity-80">Boas notícias! Mesmo assim, use sempre passwords únicas para cada serviço.</p>
                    </div>
                `;
                return;
            }

            // Mostrar vazamentos encontrados (formato real da HIBP API)
            let breachesHTML = '';
            breaches.forEach(breach => {
                // A HIBP API retorna: Name, Domain, BreachDate, PwnCount, DataClasses, Description, etc.
                const name = breach.Name || breach.name || 'Desconhecido';
                const domain = breach.Domain || breach.domain || 'N/A';
                const breachDate = breach.BreachDate || breach.breachDate || 'N/A';
                const pwnCount = breach.PwnCount || breach.pwnCount || 0;
                const dataClasses = breach.DataClasses || breach.dataClasses || [];
                const description = breach.Description || breach.description || '';
                
                breachesHTML += `
                    <div class="bg-gray-800 p-5 rounded-xl mb-4 border-l-4 border-red-500">
                        <div class="flex justify-between items-start flex-wrap gap-2">
                            <div>
                                <h4 class="font-bold text-lg">${name}</h4>
                                <p class="text-sm opacity-80">Domínio: ${domain} | Data: ${breachDate}</p>
                            </div>
                            <div class="bg-red-900 text-red-300 px-3 py-1 rounded-full text-sm font-semibold">
                                ${pwnCount.toLocaleString()} contas
                            </div>
                        </div>
                        ${dataClasses.length > 0 ? `
                        <div class="mt-3 flex flex-wrap gap-2">
                            ${dataClasses.map(dc => `<span class="bg-gray-700 px-2 py-1 rounded text-xs">${dc}</span>`).join('')}
                        </div>
                        ` : ''}
                        ${description ? `
                        <div class="mt-3 text-sm opacity-90">
                            <p>${description.substring(0, 200)}${description.length > 200 ? '...' : ''}</p>
                        </div>
                        ` : ''}
                    </div>
                `;
            });

            resultsContainer.innerHTML = `
                <div class="mb-6">
                    <div class="w-20 h-20 bg-red-900 text-red-400 rounded-full flex items-center justify-center mx-auto mb-4">
                        <i class="fas fa-exclamation-triangle text-3xl"></i>
                    </div>
                    <h3 class="text-2xl font-bold mb-2 text-center">Vazamentos Encontrados!</h3>
                    <p class="text-center opacity-90 mb-6">O email <strong>${email}</strong> foi encontrado em <strong>${breaches.length}</strong> vazamento(s).</p>
                </div>
                <div class="max-h-96 overflow-y-auto pr-2">
                    ${breachesHTML}
                </div>
                <div class="mt-6 p-4 bg-blue-900 rounded-xl">
                    <p class="text-sm"><i class="fas fa-lightbulb mr-2"></i><strong>Recomendação:</strong> Altere as passwords destes serviços e ative autenticação de dois fatores onde possível.</p>
                </div>
            `;
        }

        // Function to check email via REAL Render backend proxy
        async function checkEmail(email) {
            // Show loading state
            resultsContainer.innerHTML = `
                <div class="text-center py-10">
                    <div class="inline-block animate-spin rounded-full h-12 w-12 border-t-2 border-b-2 border-blue-500 mb-4"></div>
                    <h3 class="text-xl font-bold mb-2">A verificar vazamentos...</h3>
                    <p class="opacity-90">A consultar Have I Been Pwned API via backend Render...</p>
                    <p class="text-xs opacity-60 mt-2">Nota: O servidor Render pode demorar ~30s se estiver em cold start</p>
                </div>
            `;

            // Use same-origin `/api/...` and let Vercel rewrite proxy to Render.
            const API_BASE = '';
            
            try {
                console.log(`[HIBP] Checking email: ${email}`);
                console.log(`[HIBP] Calling: ${API_BASE}/api/hibp/check/${encodeURIComponent(email)}`);
                
                // Chamada REAL ao backend Render
                const response = await fetch(`${API_BASE}/api/hibp/check/${encodeURIComponent(email)}`, {
                    method: 'GET',
                    headers: {
                        'Accept': 'application/json'
                    }
                });
                
                console.log(`[HIBP] Response status: ${response.status}`);
                
                // Se não encontrou vazamentos (404 na HIBP API significa "não encontrado")
                if (response.status === 404) {
                    console.log('[HIBP] No breaches found (404)');
                    return { email, breaches: [], error: null };
                }
                
                // Se houve erro
                if (!response.ok) {
                    const errorText = await response.text();
                    console.error('[HIBP] Backend error:', response.status, errorText);
                    return { email, breaches: [], error: `Erro ${response.status}: ${errorText || 'Falha na comunicação com o backend'}` };
                }
                
                // Sucesso - tem vazamentos
                const breaches = await response.json();
                console.log(`[HIBP] Found ${breaches.length} breaches:`, breaches);
                return { email, breaches, error: null };
                
            } catch (error) {
                console.error('[HIBP] Fetch error:', error);
                return { email, breaches: [], error: `Erro de conexão: ${error.message}. Verifique se o backend está online.` };
            }
        }

        // Function to simulate dataset update
        function updateDataset() {
            if (datasetUpdateInProgress) return;
            
            datasetUpdateInProgress = true;
            updateDatasetBtn.disabled = true;
            updateDatasetBtn.innerHTML = '<i class="fas fa-spinner animate-spin mr-3"></i>Updating Dataset...';
            datasetStatus.textContent = 'Updating...';
            datasetStatus.className = 'px-3 py-1 bg-yellow-900 text-yellow-300 rounded-full text-sm font-semibold';
            
            let progress = 0;
            const interval = setInterval(() => {
                progress += 10;
                datasetProgress.style.width = `${progress}%`;
                
                if (progress >= 100) {
                    clearInterval(interval);
                    
                    // Update completion
                    datasetLastUpdated = new Date();
                    lastUpdated.textContent = `Last updated: ${formatDate(datasetLastUpdated)}`;
                    
                    datasetStatus.textContent = 'Up to date';
                    datasetStatus.className = 'px-3 py-1 bg-green-900 text-green-300 rounded-full text-sm font-semibold';
                    datasetProgress.style.width = '100%';
                    
                    updateDatasetBtn.disabled = false;
                    updateDatasetBtn.innerHTML = '<i class="fas fa-sync-alt mr-3"></i>Simulate Dataset Update';
                    datasetUpdateInProgress = false;
                    
                    // Show success message
                    alert('Dataset updated successfully! New breach data has been fetched from sources and uploaded to Hugging Face.');
                }
            }, 300);
        }

        // Function to test the proxy connection
        async function testProxy() {
            testProxyBtn.disabled = true;
            testProxyBtn.innerHTML = '<i class="fas fa-spinner animate-spin mr-2"></i>Testing...';
            
            try {
                // Try to fetch from the proxy (using a simple endpoint if available)
                // Since we don't know the exact endpoint, we'll try a simple GET
                // Call an API endpoint through the Vercel rewrite.
                const response = await fetch('/api/stats', { method: 'GET' });
                
                setTimeout(() => {
                    if (response.status) {
                        alert(`Proxy is reachable! Status: ${response.status}`);
                    } else {
                        alert('Proxy is reachable but returned an unexpected response.');
                    }
                    testProxyBtn.disabled = false;
                    testProxyBtn.innerHTML = 'Test Proxy';
                }, 1000);
            } catch (error) {
                setTimeout(() => {
                    alert('Could not connect to the proxy. It might be offline or the endpoint may be different.');
                    testProxyBtn.disabled = false;
                    testProxyBtn.innerHTML = 'Test Proxy';
                }, 1000);
            }
        }

        // Event Listeners
        checkBtn.addEventListener('click', async () => {
            const email = emailInput.value.trim();
            if (!email) {
                alert('Please enter an email address');
                return;
            }
            
            // Basic email validation
            if (!email.includes('@') || !email.includes('.')) {
                alert('Please enter a valid email address');
                return;
            }
            
            const result = await checkEmail(email);
            displayResults(result.email, result.breaches, result.error);
        });

        // Allow Enter key to trigger check
        emailInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                checkBtn.click();
            }
        });

        updateDatasetBtn.addEventListener('click', updateDataset);
        testProxyBtn.addEventListener('click', testProxy);

        // Initialize with a sample check on page load (after a delay)
        setTimeout(() => {
            emailInput.value = 'test@example.com';
            // Don't auto-check to avoid confusion
        }, 1000);
    </script>
</body>
</html>