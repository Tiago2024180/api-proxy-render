name: Update Dataset

on:
  workflow_dispatch:
  schedule:
    - cron: '0 2 * * *' # daily at 02:00 UTC

jobs:
  update:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: '18'

      - name: Install backend deps
        working-directory: backend-render
        run: npm install

      - name: Validate HIBP secret
        env:
          HIBP_SECRET: ${{ secrets.HIBP_API_KEY || secrets.HIBP_KEY }}
        run: |
          if [ -z "${HIBP_SECRET}" ]; then
            echo "Missing GitHub secret: HIBP_API_KEY (recommended) or HIBP_KEY"
            exit 1
          fi

      - name: Validate Hugging Face secrets
        env:
          HF_TOKEN: ${{ secrets.HF_TOKEN }}
          HF_REPO: ${{ secrets.HF_REPO }}
        run: |
          if [ -z "${HF_TOKEN}" ] || [ -z "${HF_REPO}" ]; then
            echo "Missing GitHub secrets for Hugging Face upload: HF_TOKEN and HF_REPO"
            echo "Add them in GitHub: Settings -> Secrets and variables -> Actions"
            exit 1
          fi

      - name: Download previous HF snapshot (best-effort)
        env:
          HF_REPO: ${{ secrets.HF_REPO }}
        run: |
          mkdir -p backend-render/datasets
          url="https://huggingface.co/datasets/${HF_REPO}/resolve/main/datasets/breaches-latest.json"
          echo "Downloading: ${url}"
          curl -sSfL "${url}" -o backend-render/datasets/breaches-latest.json || echo "No previous snapshot yet (first run)"

      - name: Run dataset updater
        working-directory: backend-render
        env:
          HIBP_API_KEY: ${{ secrets.HIBP_API_KEY || secrets.HIBP_KEY }}
        run: node scripts/update_dataset.js

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.10'

      - name: Install hf dependencies
        run: pip install huggingface_hub

      - name: Upload to Hugging Face
        working-directory: backend-render
        env:
          HF_TOKEN: ${{ secrets.HF_TOKEN }}
          HF_REPO: ${{ secrets.HF_REPO }}
        run: python3 scripts/upload_to_hf.py

      - name: Upload dataset artifacts
        uses: actions/upload-artifact@v4
        with:
          name: datasets
          path: backend-render/datasets
